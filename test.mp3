from vosk import Model, KaldiRecognizer, SetLogLevel

import os
import wave
import json
from pydub import AudioSegment

SetLogLevel(-1)


def transcribe_audio_vosk_direct(audio_file_path, vosk_model_path="vosk-model-small-en-us-0.15"):
    if not os.path.exists(vosk_model_path):
        return f"Error: Vosk model not found at {vosk_model_path}. Please download and extract it."

    try:
        audio = AudioSegment.from_file(audio_file_path)

        if audio.channels != 1 or audio.frame_rate != 16000 or audio.sample_width != 2:
            audio = audio.set_channels(1).set_frame_rate(16000).set_sample_width(2)

        temp_wav_path = "temp_vosk_input.wav"
        audio.export(temp_wav_path, format="wav")

        model = Model(vosk_model_path)
        rec = KaldiRecognizer(model, 16000)

        result_text = ""
        with wave.open(temp_wav_path, "rb") as wf:
            if wf.getnchannels() != 1 or wf.getsampwidth() != 2 or wf.getframerate() != 16000:
                pass

            while True:
                data = wf.readframes(4000)
                if len(data) == 0:
                    break
                if rec.AcceptWaveform(data):
                    result_json = json.loads(rec.Result())
                    result_text += result_json.get("text", "") + " "
           
            final_result_json = json.loads(rec.FinalResult())
            result_text += final_result_json.get("text", "")

        return result_text.strip()

    except FileNotFoundError:
        return f"Error: Audio file not found at '{audio_file_path}'."
    except Exception as e:
        return f"An unexpected error occurred: {e}"
    finally:
        if os.path.exists(temp_wav_path):
            os.remove(temp_wav_path)

def main():
    print("--- Simple Speech Recognition System (Vosk Direct) ---")
    audio_file = input("Enter the path to your audio file (e.g., 'D:\recordings\test.mp3.m4a): ")
    vosk_model_dir = "vosk-model-small-en-us-0.15"

    transcribed_text = transcribe_audio_vosk_direct(audio_file, vosk_model_dir)
    print("\n--- Transcription Result ---")
    print(transcribed_text)
    print("----------------------------")

if __name__ == "__main__":

    main()
